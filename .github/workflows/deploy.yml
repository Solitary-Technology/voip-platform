name: Deploy to Production

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "=== Starting Deployment ==="
          
          cd /opt/voip-api
          
          # Reset any local changes and pull latest
          echo "Pulling latest code..."
          sudo git reset --hard origin/master
          sudo git pull origin master
          
          # Install/update Python dependencies
          echo "Installing dependencies..."
          cd /opt/voip-api
          sudo -u root bash << 'SCRIPT'
          source /opt/voip-api/venv/bin/activate
          pip install -r /opt/voip-api/requirements.txt
          SCRIPT
          
          # Copy FreeSWITCH configs if they exist
          if [ -d "/opt/voip-api/freeswitch-config/autoload_configs" ]; then
            echo "Updating FreeSWITCH configuration..."
            sudo cp -r /opt/voip-api/freeswitch-config/autoload_configs/* /etc/freeswitch/autoload_configs/
            sudo fs_cli -x "reloadxml"
          fi
          
          # Restart API service
          echo "Restarting API service..."
          sudo systemctl restart voip-api
          
          # Wait and check service status
          sleep 3
          if sudo systemctl is-active --quiet voip-api; then
            echo "✓ API service is running"
          else
            echo "✗ API service failed to start"
            exit 1
          fi
          
          echo "=== Deployment Complete ==="